<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live chat</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
    <div id="enter-chat-panel" class="panel">
        <form action="javascript:enterChat()" id="enter-chat-form">
            <h1>Digite seu nome</h1>
            <input type="text" id="name-input"> 
            <input type="submit" name="Entrar" value="Entrar">
        </form>  
        
    </div>
    <div id="chat-panel" class="panel hide-element">
        <ul id="users-online"></ul>
        <div>            
            <div id="messagesReceived"></div>
            <input type="text" id="textArea">
            <button onclick="sendMessage()">Enviar mensagem</button>
        </div>
    </div>
   
    <script type="text/javascript">
        var socket;

        var messagesReceived = document.getElementById('messagesReceived');
        var textArea =  document.getElementById('textArea');

        var selectedUser;

        
        function enterChat(input){
            const name = document.getElementById('name-input').value;

            if (!name){
                alert('Por favor insira um nome');
                return
            }

            socket = new WebSocket(`ws://localhost:8080?user=${name}`);

            socket.addEventListener("open", (event) => {
                console.log('Conectado') 
                getOnlineUsersList()
                startChat()
            });

            socket.addEventListener("message", async (event) => {
                console.log(`Mensagem recebida: ${event.data}`)
                const message = JSON.parse(event.data);

                if (message.action === 'online-users'){
                    updateOnlineUsers(message.onlineUsers)
                }

                if (message.action === 'receive-message'){
                    messagesReceived.innerHTML += `${message.message}\r\n`
                }
            });

            socket.addEventListener("error", (event) => {
                console.log("Ocorreu um erro na comunicação: ", event);
            });

            socket.addEventListener("close", (event) => {
                console.log("A conexão foi encerrada");
            });
        }

        function getOnlineUsersList(){
            socket.send(JSON.stringify({action: 'get-online-users'}))
        }

        function startChat(){
            const enterChatPanel = document.getElementById('enter-chat-panel');
            const chatPanel = document.getElementById('chat-panel');
            enterChatPanel.classList.toggle('hide-element'); 
            chatPanel.classList.toggle('hide-element'); 

        }


        function sendMessage(){
            console.log(`Sending message: ${textArea.value}`);
            socket.send(JSON.stringify({action: 'send-message', receiver: selectedUser, message: textArea.value}))
            textArea.value = '';
        }

        function updateOnlineUsers(onlineUsers){
            const ul = document.getElementById('users-online')
            const childrenArray = Array.from(ul.children);
            console.log(childrenArray)

            for (const onlineUser of onlineUsers){

                const userItemFound = childrenArray.find(child => child.id === onlineUser);

                if(!userItemFound){
                    const newUserItem = document.createElement('il');
                    newUserItem.id = onlineUser
                    newUserItem.classList.add('user-list-item')
                    newUserItem.textContent = onlineUser
                    newUserItem.onclick = selectUser;

                    const avatar = document.createElement('img')
                    avatar.src = 'https://avatar.iran.liara.run/username?username=' + onlineUser
                    avatar.alt = onlineUser
                    avatar.classList.add('avatar')
                    newUserItem.insertBefore(avatar, newUserItem.firstChild)
                    ul.appendChild(newUserItem)
                }

            }
        }

        function selectUser(event){
            selectedUser = event.srcElement.id
        }
    </script>
</body>
</html>