<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live chat</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
    <div id="panel">
        <h1>Digite seu nome</h1>
        <form action="javascript:enterChat()" id="enter-chat-form">
            <input type="text" id="name-input"> 
            <input type="submit" name="Entrar" value="Entrar">
        </form>  
    </div>
   
    <script type="text/javascript">
        let socket;

        let messagesReceived;
        let textArea;
        let sendMessageButton;
        
        function enterChat(input){
            const name = document.getElementById('name-input').value;

            if (!name){
                alert('Por favor insira um nome');
                return
            }

            socket = new WebSocket(`ws://localhost:8080?user=${name}`);

            socket.addEventListener("open", (event) => {
                console.log('Conectado') 
                getOnlineUsersList()
                startChat()
            });

            socket.addEventListener("message", async (event) => {
                console.log(event)
                console.log(await  event.data.text())
                const message = JSON.parse(await event.data.text());
                console.log(`Mensagem recebida: ${message}`)
                if (message.action === 'receive-message'){
                    messagesReceived.innerHTML += `${message.message}\r\n`
                }
            });

            socket.addEventListener("error", (event) => {
                console.log("Ocorreu um erro na comunicação: ", event);
            });

            socket.addEventListener("close", (event) => {
                console.log("A conexão foi encerrada");
            });
        }

        function getOnlineUsersList(){
            socket.send(JSON.stringify({action: 'get-online-users'}))
        }

        function startChat(){
            messagesReceived = document.createElement('div')
            textArea = document.createElement('textarea')
            sendMessageButton = document.createElement('button', {})
            sendMessageButton.innerHTML = 'Enviar mensagem';
            sendMessageButton.addEventListener('click', sendMessage)
            const form = document.getElementById('enter-chat-form')

            if (form){
                form.insertAdjacentElement('afterend', messagesReceived)
                messagesReceived.insertAdjacentElement('afterend', textArea)
                textArea.insertAdjacentElement('afterend', sendMessageButton)
            }

        }


        function sendMessage(message, teste){
            console.log(`Sending message: ${textArea.value}`);
            socket.send(JSON.stringify({action: 'send-message', receiver: 'recebedor', message: textArea.value}))
            textArea.value = '';
        }
    </script>
</body>
</html>